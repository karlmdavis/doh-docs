--- 
title: Eddings Web Server
kind: topic
summary: "Describes the steps necessary to make eddings a web server."
---


# <%= @item[:title] %>

This <%= topic_link("/it/davis/servers/eddings/") %> sub-guide describes the steps necessary to make the computer a web server, using [Apache httpd](http://httpd.apache.org/).

Previously, I'd been using `tolkien` as a web server, which has now been decommissioned. The documentation for the old `tolkien` web server is archived in the following pages:

* <%= wiki_entry_link("TolkienSetupSvn") %>
* <%= wiki_entry_link("TolkienSetupTrac") %>
* <%= wiki_entry_link("TolkienSetupWebDav") %>
* <%= wiki_entry_link("TolkienSetupWordpress") %>

Please note that all of those services (SVN, Trac, WebDAV, and WordPress) are no longer being used. I was uncomfortable with their security and usabilty and have opted for the following alternatives:

* My SVN repositories were all migrated to [GitHub](https://github.com/karlmdavis) and [bitbucket](https://bitbucket.org/karlmdavis).
* My Trac projects have all been either converted into this [nanoc](http://nanoc.stoneship.org/)-powered site or archived.
* My WebDAV shares were all decommissioned.
* My WordPress blog was migrated into this [nanoc](http://nanoc.stoneship.org/)-powered site: <%= topic_link("/blog/") %>.

The portions of my web content now generated by [nanoc](http://nanoc.stoneship.org/) are all hosted by the [Apache httpd](http://httpd.apache.org/) server described in this page.

Much of the content for this page was derived from Ubuntu's Apache web server documentation: <https://help.ubuntu.com/10.04/serverguide/httpd.html>.


## Installing Apache httpd

[Apache's httpd](http://www.isc.org/software/bind) seems to be, by far, the most popular web server package for Linux. I've had good success with it, myself. Installing it is as simple as:

    $ sudo apt-get install apache2


## Basic Configuration

The Apache web server supports [virtual hosts](http://httpd.apache.org/docs/2.2/vhosts/): the ability to serve different web sites based on the URL and/or IP used to access the site. The default Ubuntu install of Apache will create and enable a `default` virtual site that displays a basic "It Works!" message. We want to disable this site:

    $ sudo a2dissite default
    $ sudo /etc/init.d/apache2 reload


## SSL Encryption

References:

* [Apache: Force HTTPS Connections](http://www.cyberciti.biz/tips/howto-apache-force-https-secure-connections.html)

By default, Apache uses unencrypted HTTP for all traffic. This means that all of the traffic, including any usernames and passwords entered, are sent out as (essentially) clear text, viewable by anyone who happens to be listening. For security, it's best to force all traffic to instead use encrypted HTTPS.

First, enable Apache's [mod_ssl](http://httpd.apache.org/docs/2.2/mod/mod_ssl.html) module:

    $ sudo a2enmod ssl

The rest of the SSL configuration is provided below, as part of the `justdavis.com` site configuration.


### Create Site: justdavis.com

References:

* <http://httpd.apache.org/docs/2.2/vhosts/ip-based.html>
* <http://httpd.apache.org/docs/2.2/mod/mod_rewrite.html>
* <http://httpd.apache.org/docs/2.2/mod/core.html#options>

The `justdavis.com` domain will be used to serve static web content generated by `nanoc`.

Create the folders that will be used to store the content, logs, etc. for the site:

    $ sudo mkdir -p /var/apache2/justdavis.com/www/
    $ sudo mkdir -p /var/apache2/justdavis.com/logs/
    $ sudo chown -R root:root /var/apache2/justdavis.com/
    $ sudo chmod -R u=rwX,g=rX,o=rX /var/apache2/justdavis.com/

Create the site configuration in `/etc/apache2/sites-available/justdavis.com`:

~~~~
<VirtualHost 174.79.40.37:443>
	DocumentRoot /var/apache2/justdavis.com/www/
	ErrorLog /var/apache2/justdavis.com/logs/error_log
	LogLevel warn
	TransferLog /var/apache2/justdavis.com/logs/access_log

	ServerName justdavis.com
	ServerAdmin webmaster@justdavis.com

	Options FollowSymLinks

	# Configure SSL for this virtual host (derived from /etc/apache2/sites-available/default-ssl)
	SSLEngine on
	SSLCertificateFile /etc/ssl/certs/www.justdavis.com.crt
	SSLCertificateKeyFile /etc/ssl/private/www.justdavis.com.key
	<FilesMatch "\.(cgi|shtml|phtml|php)$">
		SSLOptions +StdEnvVars
	</FilesMatch>
	<Directory /usr/lib/cgi-bin>
		SSLOptions +StdEnvVars
	</Directory>
	BrowserMatch "MSIE [2-6]" \
		nokeepalive ssl-unclean-shutdown \
		downgrade-1.0 force-response-1.0
	# MSIE 7 and newer should be able to use keepalive
	BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown

	# Redirects from http://madrivercode.com/blog/ to https://justdavis.com/karl/blog/
	RewriteEngine on
	# Redirect: resume:
	RewriteRule ^/blog/wp-content/uploads/2009/03/karlmdavis-resume.pdf(.*) https://justdavis.com/karl/downloads/karlmdavis-swEngineer-resume.pdf [R=permanent,L]
	# Redirect: 2009-03-21 article:
	RewriteRule ^/blog/coding/native-libraries-vcs-and-maven(.*) https://justdavis.com/karl/blog/2009/03/21/intrepid_vpn_troubles.html [R=permanent,L]
	# Redirect: 2009-09-05 article:
	RewriteRule ^/blog/uncategorized/a-sad-tale-of-vpn-troubles-on-intrepid/(.*) https://justdavis.com/karl/blog/2009/09/05/native_libraries_maven.html [R=permanent,L]
	# Redirect: everything else:
	RewriteRule ^/blog(.*) https://justdavis.com/karl/blog/ [R=permanent,L]
</VirtualHost>
<VirtualHost 174.79.40.37:80>
	# Redirect all HTTP (port 80) traffic for this virtual host to HTTPS.	
	RewriteEngine on
	RewriteCond %{HTTPS} off
	RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI}
</VirtualHost>
~~~~

Enable the site as follows:

    $ sudo a2enmod rewrite
    $ sudo a2ensite justdavis.com
    $ sudo service apache2 restart


### Creating the HTTPS Service Certificate

Note that the configuration above references an SSL certificate and key file. We'll use the CA from <%= topic_link("/it/davis/servers/eddings/ldap/") %> to create these for the HTTPS `justdavis.com` site.

First, create a private key for the site, secure it, and store it in the server's central `/etc/ssl/private/` directory:

    $ sudo certtool --generate-privkey --outfile /etc/ssl/private/www.justdavis.com.key
    $ sudo chmod u=rw,g=r,o= /etc/ssl/private/justdavis.com.key
    $ sudo chown root:ssl-cert /etc/ssl/private/justdavis.com.key

When using a commercial CA, a "certificate signing request" is needed. However, when using a local CA, this step can be skipped. Instead, we'll directly use our CA's private key, public certificate, and the private key for the service to generate the public certificate for the service. A configuration template file for the service's public certificate should be created as `/etc/ssl/certs/www.justdavis.com.cfg` with the following contents:

~~~~
# X.509 Certificate options
#
# DN options

# The organization of the subject.
organization = "Davis Family"

# The organizational unit of the subject.
#unit = "sleeping dept."

# The state of the certificate owner.
state = "Arizona"

# The country of the subject. Two letter code.
country = US

# The common name of the certificate owner.
cn = "Karl M. Davis"

# The serial number of the certificate. Should be incremented each time a new certificate is generated.
serial = 001

# In how many days, counting from today, this certificate will expire.
expiration_days = 3650

# X.509 v3 extensions

# DNS name(s) of the server
dns_name = "justdavis.com"
dns_name = "www.justdavis.com"
#dns_name = "server_alias.example.com"

# (Optional) Server IP address
#ip_address = "192.168.1.1"

# Whether this certificate will be used for a TLS client
#tls_www_client

# Whether this certificate will be used for a TLS server
tls_www_server

# Whether this certificate will be used to encrypt data (needed
# in TLS RSA ciphersuites). Note that it is preferred to use different
# keys for encryption and signing.
encryption_key
~~~~

Generate the public certificate for the service, placing it into the `/etc/ssl/certs/` directory:

    $ sudo certtool --generate-certificate --load-privkey /etc/ssl/private/www.justdavis.com.key --load-ca-certificate /usr/local/share/ca-certificates/ca.justdavis.com.crt --load-ca-privkey /etc/ssl/private/ca.justdavis.com.key --template /etc/ssl/certs/www.justdavis.com.cfg --outfile /etc/ssl/certs/www.justdavis.com.crt
    $ sudo chmod u=rw,g=r,o=r /etc/ssl/certs/www.justdavis.com.crt
    $ sudo chown root:root /etc/ssl/certs/www.justdavis.com.crt

